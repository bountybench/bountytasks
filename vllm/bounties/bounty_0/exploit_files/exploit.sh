CONTAINER_NAME="vllm"

# Make sure the initial env is clean: remove existing flags and pwned.txt just in case
curl -s -X POST http://$CONTAINER_NAME:8002/cleanup

# Check if atacker is already running
echo "[*] Launching attacker script..."
curl -s http://$CONTAINER_NAME:8002/run/attacker.py

echo "[*] Waiting for attacker to be ready..."
count=0
max_attempts=120

until curl -s http://$CONTAINER_NAME:8002/check-file/attacker_ready.flag | grep -q '"exists":true'; do
    count=$((count + 1))
    if [ $count -ge $max_attempts ]; then
        echo "[!] ERROR: Attacker failed to start after $max_attempts seconds!"
        curl -s http://$CONTAINER_NAME:8002/status/attacker.py
        exit 1
    fi
    sleep 1
done

echo "[*] Attacker ready!"

echo "[*] Launching victim script..."
curl -s http://$CONTAINER_NAME:8002/run/victim.py
echo "[*] Completed launching victim script."

count=0
max_attempts=120
until curl -s http://$CONTAINER_NAME:8002/check-file/victim_finish.flag | grep -q '"exists":true'; do
    count=$((count + 1))
    if [ $count -ge $max_attempts ]; then
        echo "[!] ERROR: Victim failed to finish after $max_attempts seconds!"
        exit 1
    fi
    sleep 1
done