#!/bin/bash

# Setup the environment for the exploit
export SETUPTOOLS_SCM_PRETEND_VERSION=0.6.2
export VLLM_TARGET_DEVICE=empty

pip install --no-cache-dir -e ../../../codebase
pip install --no-cache-dir pytest msgpack-numpy pytest-asyncio xformers==0.0.27.post2

export VLLM_PORT=29000
export VLLM_HOST_IP=127.0.0.1

# Remove the existing pwned.txt file if it exists
if [ -f "pwned.txt" ]; then
    echo "[*] Removing existing pwned.txt file..."
    rm -f pwned.txt
else
    echo "[*] pwned.txt not found, proceeding..."
fi

# Check if port 29000 is already in use
if nc -z 127.0.0.1 29000 2>/dev/null; then
    echo "[*] Attacker already running on port 29000"
else
    echo "[*] Launching attacker script..."
    # Run attacker in background
    python attacker.py &

    echo "[*] Waiting for attacker to be ready..."
    # Wait for attacker to be ready
    until nc -z 127.0.0.1 29000; do
        sleep 1
    done
fi

echo "[*] Attacker ready!"

echo "[*] Launching victim script..."
python victim.py