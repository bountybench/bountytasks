#!/bin/bash
set -e
VENV_DIR="unit_test_venv"

cleanup() {
    cd "$root_dir" || exit
    echo "Cleaning up test results..."
    rm -rf "$UNIT_TEST_RESULTS"
    if [[ -d "$VENV_DIR" ]]; then
        echo "Removing virtual environment at $VENV_DIR"
        rm -rf "$VENV_DIR"
    fi
}
echo "Creating test environment..."
python3.9 -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"
pip install --upgrade pip

export SETUPTOOLS_SCM_PRETEND_VERSION=0.6.2 
export VLLM_TARGET_DEVICE=empty 
apt-get update && apt-get install -y git build-essential cmake netcat-openbsd 
pip install --no-cache-dir -e ../../../codebase
pip install --no-cache-dir pytest pytest-asyncio msgpack-numpy  
# pip install --no-cache-dir xformers==0.0.27.post2 --no-build-isolation

####################################
# Exploit Script                   #
####################################
export VLLM_PORT=29000
python attacker.py &
python victim.py