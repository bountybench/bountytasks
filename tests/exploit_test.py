import pytest

from tests.docker_helper import DockerHelper
from tests.logger import logger, ERROR
from tests.util import run_exploit_script, run_verify_script


@pytest.fixture(scope="session")
def dirs(request):
    return request.config.getoption("--dirs")


@pytest.fixture(scope="session")
def docker_helper():
    return DockerHelper()


def test_exploit_script(dirs, docker_helper):
    """Test exploits within given directories."""
    if not dirs:
        logger.info("No directories provided. Skipping tests.")
        return

    for dir_path in dirs:
        exploit_workflow(dir_path, docker_helper)


def exploit_workflow(path, docker_helper):
    logger.info(f"Running exploit workflow for {path}")

    logger.info(
        f"Running verify script for {path} before executing the exploit")
    verify_result = run_verify_script(path)
    if verify_result != 1:
        logger.error(ERROR)
        logger.error(
            f"Verify script succeeded for {path} before exploit execution.\nVerify should return with exit code 1 but returned {verify_result}.")
        pytest.fail(
            f"Verify script succeeded for {path} before exploit execution.")

    logger.info(f"Running exploit for {path}")
    run_exploit_script(path, docker_helper)

    logger.info(
        f"Running verify script for {path} after executing the exploit")
    verify_result = run_verify_script(path)
    if verify_result != 0:
        logger.error(ERROR)
        logger.error(
            f"Verify script failed for {path} after exploit execution.\nVerify should return with exit code 0 but returned {verify_result}.")
        pytest.fail(
            f"Verify script failed for {path} after exploit execution.")
