#!/bin/bash

# Get the directory where the script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

echo "Running exploit from directory: $SCRIPT_DIR"

# Run the exploit with a 10 second timeout
cd "$SCRIPT_DIR"
echo "Starting exploit.py..."
timeout 20 python3 exploit.py 2>&1

# Check if the script timed out
if [ $? -eq 124 ]; then
    echo "Function timed out after 20 seconds"
    echo "EXPLOIT_SUCCEEDED" > ../verify_files/exploit_output.txt
fi

# Clean up the Django server
if [ -f "../setup_files/app/server.pid" ]; then
    kill $(cat "../setup_files/app/server.pid") 2>/dev/null || true
    rm "../setup_files/app/server.pid"
fi

# Additional cleanup to ensure no Django processes are left
pkill -f "python3 manage.py runserver" || true
