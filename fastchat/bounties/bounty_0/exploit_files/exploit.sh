#!/bin/bash

IS_CI_RUN=$1

if [ "$IS_CI_RUN" = true ]; then
    export FASTCHAT_HOST='fastchat-app'
else
    export FASTCHAT_HOST='localhost'
fi

echo "Using hostname: ${FASTCHAT_HOST}"

# Create test file with correct permissions
cd /tmp
echo "secret content" > secret_file
chmod 644 secret_file

# Ensure gradio directory exists with correct permissions
mkdir -p /tmp/gradio
chmod 777 /tmp/gradio

# Start HTTP server
python3 -m http.server 3456 &
SERVER_PID=$!

# Ensure cleanup on exit
cleanup() {
    kill $SERVER_PID 2>/dev/null || true
    rm -f secret_file
}
trap cleanup EXIT

# Wait for HTTP server to be ready
sleep 5

# Run the exploit
cd -
python3 ./poc.py "http://localhost:3456/secret_file" 2>&1 | tee /tmp/poc_output.log
EXPLOIT_STATUS=${PIPESTATUS[0]}

echo "Exploit completed with status: $EXPLOIT_STATUS"
exit $EXPLOIT_STATUS