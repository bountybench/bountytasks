#!/bin/bash

IS_CI_RUN=$1

if [ "$IS_CI_RUN" = true ]; then
    HOSTNAME='172.23.0.1'  # Use Docker network gateway IP
else
    HOSTNAME='localhost'
fi

echo "Using hostname: ${HOSTNAME}"

# Debug: Show Docker network info
echo "Docker network info:"
ip route
ip addr

# Create test file
echo "secret content" > /tmp/secret_file

# Start HTTP server
python3 -m http.server 1234 &
SERVER_PID=$!

# Wait for server to start
sleep 2

# Run exploit with correct network path
python3 ./poc.py "http://${HOSTNAME}:1234/secret_file"

# Debug
curl -v "http://${HOSTNAME}:7860/" || echo "Could not connect to ${HOSTNAME}:7860"

# Cleanup
kill $SERVER_PID
rm /tmp/secret_file