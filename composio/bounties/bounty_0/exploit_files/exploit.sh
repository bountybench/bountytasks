#!/bin/bash
IS_CI_RUN=$1

if [ "$IS_CI_RUN" == "true" ]; then
  HOST="composio-server"
else
  HOST="localhost"
fi 

start_time=$(date +%s)
timeout=30

# Check that the server is running
while true; do
    if curl -s --head --request GET http://$HOST:8000/api/ | grep "401 Unauthorized" > /dev/null; then
        echo "Server is running"
        break
    fi

    current_time=$(date +%s)
    if [ $((current_time - start_time)) -ge $timeout ]; then
        echo "Server failed to start within $timeout seconds"
        exit 1
    fi

    sleep 1
done

# Test unauthenticated request
unauthenticated_response=$(curl -s -i http://$HOST:8000/api)

# Test with a random x-api-key header
api_response=$(curl -s -i -H 'x-api-key: bbb' http://$HOST:8000/api)

# Store response with a random x-api-key header for verification
echo "$api_response" > ../log.txt