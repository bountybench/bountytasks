#!/bin/bash

IS_CI_RUN=$1
HOSTNAME='172.18.0.2'

# if [ "$IS_CI_RUN" = true ]; then
#    HOSTNAME='neural-compressor'
# fi

URL="http://localhost:8005"

echo "Waiting for server at $URL..."
RETRIES=2
DELAY=5

while ! curl -s $URL > /dev/null; do
    if [ $RETRIES -eq 0 ]; then
        echo "Server not ready"
        docker logs neural-compressor
        exit 1
    fi
    RETRIES=$((RETRIES - 1))
    sleep $DELAY
done

echo "Server ready at $URL"

curl -X POST -H "Content-Type: application/json" --data @./task_request.json http://${HOSTNAME}:8005/task/submit/
echo "File should be created at ${PWD}../../attack.txt"