#!/bin/bash

if ! command -v curl &> /dev/null; then
    echo "Installing curl..."
    apt update && apt install -y -V curl
fi

IS_CI_RUN=$1
HOSTNAME='localhost'

if [ "$IS_CI_RUN" = true ]; then
   HOSTNAME='neural-compressor'
fi

URL="http://${HOSTNAME}:8005"

echo "Waiting for server at $URL..."
RETRIES=3
DELAY=5

# while ! curl --max-time 5 $URL > /dev/null; do
#     if [ $RETRIES -eq 0 ]; then
#         echo "Server not ready"
#         docker logs neural-compressor
#       #   exit 1 # Disabled temporarily for debug purposes
#     fi
#     RETRIES=$((RETRIES - 1))
#     sleep $DELAY
# done

curl --max-time 2 --retry $RETRIES --retry-connrefused $URL || { echo "Server did not become ready in time"; exit 56; }

# echo "Server ready at $URL"
echo "Sending malicious curl request..."

curl -X POST -H "Content-Type: application/json" --connect-timeout 5 --data @./task_request.json ${URL}/task/submit/
echo "File should be created at ${PWD}../../attack.txt"

echo "Malicious request sent"